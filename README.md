MGM-PFAS-generation
---

Two strategies were employed for PFAS structure generation. The PFAS generation model based on data augmentation is referred to as A-LSTM, while the model based on transfer learning is referred to as T-LSTM. Since the two algorithms rely on different modeling environments, it is recommended to create separate virtual environments for each.


A-LSTM
---

First, you need to clone the repository :
```
git clone git@github.com:ETHmodlab/hybridCLMs.git
```
Then, you need to create the required Conda environment using the provided environment.yml file, run the following command:
```
cd A-LSTM/
conda env create -f env_A-LSTM.yml -n A-LSTM
```
Once the installation is done, you can activate the virtual conda environment for this project:
```
conda activate A-LSTM
```
Please note that you will need to activate this virtual conda environment every time you want to use this project. 

The scripts in the `A-LSTM/python` directory were used in the following order to preprocess the HighResNPS dataset, train chemical language models, evaluate the quality of the generated molecules, sample SMILES strings from the trained models, and tabulate unique molecules based on their frequency.

- `clean-SMILES.py`: preprocess chemical structures from the HighResNPS database for input during model training. 
- `augment-SMILES.py`: enumerate multiple, non-canonical SMILES for each canonical SMILES in the file output by `clean-SMILES.py`, given some fixed data augmentation factor.
- `train_model.py`: train a recurrent neural network-based generative model of chemical structures. 
`datasets.py`, `functions.py`, and `models.py` contain additional classes and functions required for model training and analysis. Arguments for usage from the command line are documented within each individual script.

T-LSTM
---

First, you need to clone the repository :
```
git clone git@github.com:ETHmodlab/hybridCLMs.git
```
Then, you need to create the required Conda environment using the provided environment.yml file, run the following command:
```
cd T-LSTM/
conda env create -f env_T-LSTM.yml -n T-LSTM
```
Once the installation is done, you can activate the virtual conda environment for this project:
```bash
conda activate T-LSTM
```
Use the available pretrained model to fine-tune,and generated PFAS SMILES.

Process the data to fine-tune the T-LSTM:
```
sh run_processing.sh configfiles/ft_clm_generation/A01_clm_ft.ini
```

Fine-tune the pretrained CLM:
```
sh run_training.sh configfiles/ft_clm_generation/A01_clm_ft.ini
```

Generate SMILES strings with the fine-tuned CLM:
```
sh run_generation.sh configfiles/ft_clm_generation/A01_clm_ft.ini
```
Note: this step will be slow if you sample 5,000 SMILES strings by epoch as specified in *A01_clm_ft.ini* without a GPU. We advised you to first try with 500 SMILES strings (to do so, you can update the value in *A01_clm_ft.ini*).

Process the generated SMILES strings to get the new molecules to constitute the focused virtual chemical library:
```
sh run_novo.sh configfiles/ft_clm_generation/A01_clm_ft.ini
```
Evaluation
---
These scripts were used for analyzing the generated structures, including evaluating the validity, novelty, and uniqueness of the structures generated by the two models, extracting molecular structures that meet the definition of PFAS, and generating a suspect PFAS list.
- `evaluate_generation.py` : evaluate the validity, uniqueness, and novelty of the generated structures and export the lists that contain valid structures.
- `CF2_extract.py` : extract strcutures with CF2 groups from valid strcutures.
- `CF2_removed.py` :  remove strcutures with CF2 groups from valid strcutures.
- `CF3_extract.py` :  extract strcutures with CF3 groups from remained valid strcutures.
- `merge_PFAS.py` : integrate structures containing CF2 or CF3 groups.
-`frequency_count.py` : count the number of times an unique molecule is repeated.
-`novel_structure.py` : remove structures that present in training set.
-`generate_suspect_list.py`:  calculate exact mass and formula for unique and novel PFAS structures and construct a list for suspect screening.
- `calculate_properties.py`: calculate a suite of chemical properties for generated strcutures.

Note
---
The original codes for A-LSTM and T-LSTM were derived from projects DOI:https://doi.org/10.1038/s42256-021-00407-x and DOI:
https://doi.org/10.1038/s41467-022-35692-6], respectively.



